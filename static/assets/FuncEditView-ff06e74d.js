import{u as Z,n as j,q as F,r as _,a as G,o as H,v as h,b as l,c as J,d as K,w as o,e as t,f as S,g as $,t as N,h as P,m as k}from"./index-53057e88.js";import{c as i,A as Q}from"./AppLayout-7b7aaf0d.js";import{_ as W}from"./MonacoEditor-95101635.js";import{R as X}from"./RollbackOutlined-c89baf36.js";import{S as Y}from"./SaveOutlined-3e324e3b.js";import{C as ee}from"./CloudUploadOutlined-bc652310.js";/* empty css                                                     */const ae={class:"editor-container"},ie={__name:"FuncEditView",setup(ne){const A=Z(),R=j(),d=F(()=>R.params.id),p=F(()=>!!d.value),f=_(!1),b=_(!1),g=_(!1),a=G({name:"",description:"",code:`# 函数实现代码

def my_function(param1, param2):
    """函数文档
    
    Args:
        param1: 参数1
        param2: 参数2
        
    Returns:
        返回值
    """
    return param1 + param2
`,depend_ids:[]}),w=_([]);H(async()=>{await E(),p.value&&await B()});const E=async()=>{g.value=!0;try{await i({method:"get",url:"/api/v1/func",params:{page:1,size:100},onSuccess:e=>{const n=p.value?e.filter(s=>s.id!==parseInt(d.value)):e;w.value=n.map(s=>({value:s.id,label:s.name}))},errorMessage:"获取函数列表失败"})}finally{g.value=!1}},B=async()=>{b.value=!0;try{await i({method:"get",url:`/api/v1/func/${d.value}`,onSuccess:e=>{a.code=e.code,r=C(e.code)||"",a.name=e.name,a.description=e.description||"",D()},errorMessage:"获取函数数据失败"})}finally{b.value=!1}},D=async()=>{try{await i({method:"get",url:`/api/v1/func/${d.value}/depend`,onSuccess:e=>{e&&Array.isArray(e)?a.depend_ids=e.map(n=>n.id):a.depend_ids=[]},errorMessage:"获取函数依赖关系失败"})}catch(e){console.error("Error fetching function dependencies:",e)}},M=()=>a.name?a.code?!0:(k.error("请输入函数代码"),!1):(k.error("请输入函数名称"),!1),x=()=>({name:a.name,description:a.description,code:a.code,depend_ids:a.depend_ids}),L=async()=>{if(M()){f.value=!0;try{const e=x();p.value?await i({method:"put",url:`/api/v1/func/${d.value}`,data:e,successMessage:"保存成功",errorMessage:"保存失败",onSuccess:()=>{m()}}):await i({method:"post",url:"/api/v1/func",data:e,successMessage:"创建成功",errorMessage:"创建失败",onSuccess:()=>{m()}})}finally{f.value=!1}}},O=async()=>{if(M()){f.value=!0;try{const e=x();p.value?await i({method:"put",url:`/api/v1/func/${d.value}/deploy`,data:e,successMessage:"保存并发布成功",errorMessage:"保存并发布失败",onSuccess:()=>{m()}}):await i({method:"post",url:"/api/v1/func/deploy",data:e,successMessage:"创建并发布成功",errorMessage:"创建并发布失败",onSuccess:()=>{m()}})}finally{f.value=!1}}},C=e=>{const n=e.match(/def\s+([a-zA-Z0-9_]+)\s*\(/);return n?n[1]:null},U=(e,n)=>{if(!e||!n||e===n)return a.code;try{const s=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");let c=a.code.replace(new RegExp(`def\\s+${s}\\s*\\(`,"g"),`def ${n}(`);return c=c.replace(new RegExp(`\\b${s}\\s*\\(`,"g"),`${n}(`),c.includes('"""')&&(c=c.replace(new RegExp(`"""\\s*${s}\\b`,"g"),`"""${n}`)),c}catch(s){return console.error("Error updating function name in code:",s),a.code}};let y=!0,r="my_function";h(()=>a.code,e=>{(y||!r)&&(r=C(e)||"my_function",y=!1)},{immediate:!0}),h(()=>a.code,e=>{!a.name&&r&&r!=="function_name"&&(a.name=r)},{immediate:!0}),h(()=>a.name,(e,n)=>{y||e&&(a.code=U(r,e),r=e)});const m=()=>{A.back()};return(e,n)=>{const s=l("a-button"),c=l("a-space"),V=l("a-input"),v=l("a-form-item"),q=l("a-textarea"),I=l("a-select"),z=l("a-form"),T=l("a-card");return J(),K(Q,{"current-page-key":"func"},{default:o(()=>[t(T,{title:p.value?"编辑函数":"创建函数"},{extra:o(()=>[t(c,null,{default:o(()=>[t(s,{onClick:m},{icon:o(()=>[t(S(X))]),default:o(()=>[$(" 返回 ")]),_:1}),t(s,{type:"primary",loading:f.value,onClick:L},{icon:o(()=>[t(S(Y))]),default:o(()=>[$(" 保存 ")]),_:1},8,["loading"]),t(s,{type:"primary",loading:f.value,onClick:O},{icon:o(()=>[t(S(ee))]),default:o(()=>[$(" "+N(p.value?"保存并发布":"创建并发布"),1)]),_:1},8,["loading"])]),_:1})]),default:o(()=>[t(z,{model:a,layout:"vertical",class:"form-container"},{default:o(()=>[t(v,{label:"函数名称",required:""},{default:o(()=>[t(V,{value:a.name,"onUpdate:value":n[0]||(n[0]=u=>a.name=u),placeholder:"请输入函数名称"},null,8,["value"])]),_:1}),t(v,{label:"函数描述"},{default:o(()=>[t(q,{value:a.description,"onUpdate:value":n[1]||(n[1]=u=>a.description=u),placeholder:"请输入函数描述",rows:3},null,8,["value"])]),_:1}),t(v,{label:"依赖函数"},{default:o(()=>[t(I,{value:a.depend_ids,"onUpdate:value":n[2]||(n[2]=u=>a.depend_ids=u),mode:"multiple",placeholder:"请选择依赖函数",loading:g.value,options:w.value},null,8,["value","loading","options"])]),_:1}),t(v,{label:"函数代码",required:""},{default:o(()=>[P("div",ae,[t(W,{value:a.code,"onUpdate:value":n[3]||(n[3]=u=>a.code=u),language:"python",options:{automaticLayout:!0,scrollBeyondLastLine:!1}},null,8,["value"])])]),_:1})]),_:1},8,["model"])]),_:1},8,["title"])]),_:1})}}};export{ie as default};
